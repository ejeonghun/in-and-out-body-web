{% extends 'base.html' %}

{% block title %}Report{% endblock %}

{% block content %}
<h2>검사결과를 확인해주세요</h2>
<form method="post">
    {% csrf_token %}
    <label for="group">그룹 선택</label>
    <select name="group" id="group">
        <option value="">-- 그룹 선택 --</option>
        {% for group in groups %}
            <option value="{{ group }}" {% if group == selected_group %}selected{% endif %}>{{ group }}</option>
        {% endfor %}
    </select>
    <button type="submit" class="button">조회</button>
</form>

<!-- 에러 메시지 표시 -->
{% if error_message %}
    <p style="color:red;">{{ error_message }}</p>
{% endif %}

{% if user_results %}
    <h3>{{ selected_group }}의 분석 현황</h3>
    <div class="table-container">
        <p>데이터를 확인해주세요</p>
        <table>
            <thead>
                <tr>
                    <th>학년</th>
                    <th>반</th>
                    <th>번호</th>
                    <th>이름</th>
                    <th>체형 분석 결과</th>
                </tr>
            </thead>
            <tbody id="userResultsTableBody">
                {% for result in user_results %}
                <tr data-id="{{ result.user.id }}" data-valid="{{ result.analysis_valid }}">
                    <td>{{ result.user.student_grade }}</td>
                    <td>{{ result.user.student_class }}</td>
                    <td>{{ result.user.student_number }}</td>
                    <td>{{ result.user.student_name }}</td>
                    <td>
                        {% if result.analysis_valid %}
                            <a href="{% url 'report_detail' result.user.id %}" class="icon-button success" aria-label="View Report">
                                <i class="fa-solid fa-check"></i>
                            </a>
                        {% else %}
                            <a href="{% url 'no_result' %}" class="icon-button error" aria-label="No Result">
                                <i class="fa-solid fa-times"></i>
                            </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="pagination-container">
            <button class="pagination-button" id="prevPage">이전</button>
            <button class="pagination-button" id="nextPage">다음</button>
        </div>
    </div>
{% endif %}

<!-- Include JavaScript for Pagination -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const rowsPerPage = 10;
        let currentPage = 1;
        const userResultsTableBody = document.getElementById('userResultsTableBody');
        const rows = Array.from(userResultsTableBody.querySelectorAll('tr'));
        const totalPages = Math.ceil(rows.length / rowsPerPage);
        
        const prevButton = document.getElementById("prevPage");
        const nextButton = document.getElementById("nextPage");

        function updatePaginationButtons() {
            prevButton.style.display = currentPage > 1 ? '' : 'none';
            nextButton.style.display = currentPage < totalPages ? '' : 'none';
        }

        function displayTable(page) {
            const startIndex = (page - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, rows.length);
            
            rows.forEach((row, index) => {
                row.style.display = (index >= startIndex && index < endIndex) ? '' : 'none';
            });

            updatePaginationButtons();
        }

        prevButton.addEventListener("click", function() {
            if (currentPage > 1) {
                currentPage--;
                displayTable(currentPage);
            }
        });

        nextButton.addEventListener("click", function() {
            if (currentPage < totalPages) {
                currentPage++;
                displayTable(currentPage);
            }
        });

        // Initial display
        displayTable(currentPage);
    });
</script>
{% endblock %}
