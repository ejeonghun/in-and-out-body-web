{% extends 'base.html' %}

{% block title %}Report{% endblock %}

{% block content %}
<h2>검사결과를 확인해주세요</h2>
<form id="dataForm" method="post">
    {% csrf_token %}
    <label for="group">그룹 선택</label>
    <select name="group" id="group">
        <option value="">-- 그룹 선택 --</option>
        {% for group in groups %}
            <option value="{{ group }}" {% if group == selected_group %}selected{% endif %}>{{ group }}</option>
        {% endfor %}
    </select>
    <button type="submit" class="button">조회</button>
</form>

<!-- Spinner Container: Initially Hidden -->
<div id="spinnerContainer" class="spinner-container" style="display: none;">
    <div class="spinner"></div>
    <p>결과를 불러오는 중입니다...</p>
</div>

<!-- 에러 메시지 표시 -->
{% if error_message %}
    <p style="color:red;">{{ error_message }}</p>
{% endif %}

{% if is_registered == False %}
    <p style="color:red;">등록된 사용자 정보가 없습니다. 사용자 정보 등록을 먼저 진행해주세요 😅</p>
{% endif %}

{% if user_results %}
    <h3>{{ selected_group }}의 분석 현황</h3>
    <div class="table-container">
        <p>데이터를 확인해주세요</p>
    
        <!-- Display progress -->
        <div class="progress-container">
            <p>진행률: {{ progress_percentage|floatformat:1 }}%</p>
            <div class="progress-bar">
                <div class="progress" style="width: {{ progress_percentage|floatformat:1 }}%;"></div>
            </div>
        </div>
    
        <table>
            <thead>
                <tr>
                    {% if request.user.user_type == 'S' %}
                        <th>학년</th>
                        <th>반</th>
                        <th>번호</th>
                    {% else %}
                        <th>부서명</th>
                    {% endif %}
                    <th>이름</th>
                    <th>체형 분석 결과</th>
                </tr>
            </thead>
            <tbody id="userResultsTableBody">
                {% for result in user_results %}
                <tr data-id="{{ result.user.id }}" data-valid="{{ result.analysis_valid }}">
                    {% if request.user.user_type == 'S' %}
                        <td>{{ result.user.student_grade }}</td>
                        <td>{{ result.user.student_class }}</td>
                        <td>{{ result.user.student_number }}</td>
                    {% else %}
                        <td>{{ result.user.department }}</td>
                    {% endif %}
                    <td>{{ result.user.student_name }}</td>
                    <td>
                        {% if result.analysis_valid %}
                            <a href="{% url 'report_detail' result.user.id %}" class="icon-button success" aria-label="View Report">
                                <i class="fa-solid fa-check"></i>
                            </a>
                        {% else %}
                            <a href="{% url 'no_result' %}" class="icon-button error" aria-label="No Result">
                                <i class="fa-solid fa-times"></i>
                            </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="pagination-container">
            <button class="pagination-button" id="prevPage">이전</button>
            <button class="pagination-button" id="nextPage">다음</button>
        </div>
    </div>
{% endif %}

<!-- Include JavaScript for Pagination and Fetch -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const rowsPerPage = 10;
    let currentPage = 1;
    const userResultsTableBody = document.getElementById('userResultsTableBody');
    let rows = [];

    if (userResultsTableBody) {
        rows = Array.from(userResultsTableBody.querySelectorAll('tr'));
    }

    let totalPages = Math.ceil(rows.length / rowsPerPage);

    const prevButton = document.getElementById("prevPage");
    const nextButton = document.getElementById("nextPage");

    function updatePaginationButtons() {
        prevButton.style.display = currentPage > 1 ? '' : 'none';
        nextButton.style.display = currentPage < totalPages ? '' : 'none';
    }

    function displayTable(page) {
        const startIndex = (page - 1) * rowsPerPage;
        const endIndex = Math.min(startIndex + rowsPerPage, rows.length);
        
        rows.forEach((row, index) => {
            row.style.display = (index >= startIndex && index < endIndex) ? '' : 'none';
        });

        updatePaginationButtons();
    }

    prevButton.addEventListener("click", function() {
        if (currentPage > 1) {
            currentPage--;
            displayTable(currentPage);
        }
    });

    nextButton.addEventListener("click", function() {
        if (currentPage < totalPages) {
            currentPage++;
            displayTable(currentPage);
        }
    });

    // 큐로 세션 스토리지 관리
    function loadQueue(key) {
        const storedQueue = sessionStorage.getItem(key);
        return storedQueue ? JSON.parse(storedQueue) : [];
    }

    function saveQueue(key, queue) {
        sessionStorage.setItem(key, JSON.stringify(queue));
    }

    function enqueue(key, data, maxSize) {
        let queue = loadQueue(key);
        queue.push(data);
        if (queue.length > maxSize) {
            queue.shift();
        }
        saveQueue(key, queue);
    }

    function dequeue(key) {
        let queue = loadQueue(key);
        const data = queue.shift();
        saveQueue(key, queue);
        return data;
    }

    function peekQueue(key) {
        const queue = loadQueue(key);
        return queue.length > 0 ? queue[0] : null;
    }

    function clearQueue(key) {
        sessionStorage.removeItem(key);
    }

    // 상태 저장
    window.addEventListener("beforeunload", () => {
        const selectedGroup = document.querySelector("#group").value;
        const tableData = rows.map(row => row.outerHTML);
        
        enqueue("selectedGroupQueue", selectedGroup, 5);
        enqueue("tableDataQueue", JSON.stringify(tableData), 5);
        sessionStorage.setItem("currentPage", currentPage);
    });

    const savedGroup = dequeue("selectedGroupQueue");
    const savedTableData = dequeue("tableDataQueue");
    const savedPage = sessionStorage.getItem("currentPage");

    if (savedGroup) {
        document.querySelector("#group").value = savedGroup;
    }

    if (savedTableData) {
        userResultsTableBody.innerHTML = JSON.parse(savedTableData).join('');
    }

    rows.length = 0;
    Array.from(userResultsTableBody.querySelectorAll('tr')).forEach(row => rows.push(row));

    totalPages = Math.ceil(rows.length / rowsPerPage);

    if (savedPage) {
        currentPage = parseInt(savedPage);
        displayTable(currentPage);
    } else {
        displayTable(currentPage);
    }

    window.addEventListener("beforeunload", () => {
        clearQueue('selectedGroupQueue');
        clearQueue('tableDataQueue');
    });

    const form = document.getElementById("dataForm");
    const spinnerContainer = document.getElementById('spinnerContainer');

    form.addEventListener('submit', function(event) {
        event.preventDefault();  // 기본 제출 동작 방지
        spinnerContainer.style.display = 'flex';  // 스피너 표시
        const formData = new FormData(form);
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
        })
        .then(response => response.text())
        .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                // 테이블 업데이트
                document.getElementById('userResultsTableBody').innerHTML = doc.getElementById('userResultsTableBody').innerHTML;

                // 새로운 rows 배열을 업데이트
                rows = Array.from(document.getElementById('userResultsTableBody').querySelectorAll('tr'));
                currentPage = 1;  // 페이지 초기화
                displayTable(currentPage);  // 테이블 재표시
                spinnerContainer.style.display = 'none';  // 스피너 숨김
            })
        .catch(error => {
            console.error('Error:', error);
            spinnerContainer.style.display = 'none';  // 오류 발생 시 스피너 숨김
        });
    });

});

// 세션스토리지 초기화
window.addEventListener("beforeunload", () => {
    sessionStorage.clear();
});

</script>
{% endblock %}
